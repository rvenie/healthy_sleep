## Обзор сервиса

Сервис представляет собой веб-приложение, предназначенное для предсказания качества сна на основе предоставленных пользователем данных. Пользователи могут регистрироваться, входить в систему, получать кредиты для использования моделей предсказания и просматривать историю своих предсказаний. Сервис использует несколько моделей машинного обучения для генерации прогнозов.

## Архитектура

Проект имеет следующую структуру каталогов:

* **core/**: Содержит основную бизнес-логику приложения, разделенную на:
  * `entities/`: Определения основных сущностей (Пользователь, Модель, Лог предсказаний).
  * `repositories/`: Абстракции для доступа к данным (репозитории для пользователей, моделей, логов).
  * `use_cases/`: Сценарии использования, реализующие бизнес-логику (регистрация пользователя, выполнение предсказания и т.д.).
* **infrastructure/**: Содержит конкретные реализации компонентов, взаимодействующих с внешним миром:
  * `db/`: Компоненты для работы с базой данных (SQLite), включая реализации репозиториев.
  * `web/controllers/`: Контроллеры Flask, обрабатывающие HTTP-запросы и взаимодействующие с `use_cases`.
  * `ml/`: Компоненты, связанные с машинным обучением (предобработка данных, обучение моделей, хранилище моделей).
* **config/**: Конфигурационные файлы, например, `settings.py` для хранения настроек приложения (секретный ключ, путь к данным).
* **main.py**: Точка входа в приложение, инициализирует и запускает Flask-приложение.
* **requirements.txt**: Файл со списком зависимостей проекта.

## API и Функциональность

Сервис предоставляет веб-интерфейс и API на базе Flask. Основные маршруты (flask routes) включают:

| Методы | Путь      | Контроллер      | Описание                                                                                                               |
| :----------- | :------------ | :------------------------ | :----------------------------------------------------------------------------------------------------------------------------- |
| GET, POST    | `/register` | `user_controller`       | Регистрация нового пользователя.                                                                  |
| GET, POST    | `/login`    | `user_controller`       | Вход пользователя в систему.                                                                           |
| GET          | `/logout`   | `user_controller`       | Выход пользователя из системы.                                                                       |
| GET          | `/profile`  | `user_controller`       | Просмотр профиля пользователя и истории его предсказаний.                    |
| GET          | `/predict`  | `prediction_controller` | Отображение формы для ввода данных и выбора модели для предсказания. |
| POST         | `/predict`  | `prediction_controller` | Отправка данных для предсказания и получение результата.                      |
| GET          | `/balance`  | `credit_controller`     | Отображение текущего баланса кредитов пользователя.                              |
| GET          | `/`         | `main.py`               | Перенаправление на страницу входа (`/login`).                                                  |
| GET          | `/static/`  | Flask                     | Обслуживание статических файлов (CSS, JS, изображения).                                |

**Ключевые компоненты и их взаимодействие:**

* **Пользователи (`user_controller.py`, `user_use_cases.py`, user_repository_impl.py):**
  * Регистрация: Новый пользователь создается с начальным балансом в 100 кредитов. Пароль хешируется с использованием SHA256.
  * Аутентификация: Проверка имени пользователя и пароля. При успешном входе, `user_id` и `username` сохраняются в сессии.
  * Профиль: Отображает информацию о пользователе и историю его предсказаний, включая входные данные и результаты.
* **Предсказания (`prediction_controller.py`, `prediction_use_cases.py`, prediction_repository_impl.py):**
  * Форма предсказания: Пользователь выбирает модель и вводит необходимые данные (признаки). Отображается текущий баланс кредитов пользователя.
  * Выполнение предсказания:
    * Списание кредитов: Перед выполнением предсказания с баланса пользователя списывается стоимость использования выбранной модели. Если кредитов недостаточно, предсказание не выполняется.
    * Обработка данных: Входные данные преобразуются для подачи в модель.
    * Получение результата: Модель генерирует предсказание качества сна.
    * Сохранение предсказания: Информация о предсказании (ID пользователя, ID модели, входные данные, результат, потраченные кредиты, временная метка) сохраняется в базе данных.
* **Кредиты (`credit_controller.py`, `credit_use_cases.py`, credit_repository_impl.py):**
  * Просмотр баланса: Пользователь может видеть свой текущий баланс кредитов.
  * Списание кредитов: Происходит автоматически при выполнении предсказания. Каждая модель имеет свою стоимость в кредитах.
* **Модели машинного обучения (model_trainer.py, `model_store.py`, model_repository_impl.py):**
  * При запуске приложения, если модели отсутствуют в базе данных, происходит их обучение. Используются следующие модели:
    * Логистическая регрессия (стоимость: 10 кредитов)
    * Random Forest (стоимость: 20 кредитов)
    * CatBoost (стоимость: 30 кредитов)
  * Обученные модели (объекты Pipeline, включающие предобработчик и классификатор) сохраняются на диск в формате `.pkl` в директорию `models/` и информация о них (имя, тип, стоимость, путь к файлу) заносится в базу данных.
  * `model_store.py` обеспечивает кэширование загруженных моделей и имен признаков для быстрого доступа во время работы приложения.
* **Предобработка данных (`data_preprocessing.py`):**
  * Загружает данные из CSV-файла (путь указан в `DATA_PATH` в `config/settings.py`).
  * Целевой переменной является "Sleep quality".
  * Выполняет разделение признаков на числовые и категориальные. Числовые признаки масштабируются с помощью `StandardScaler`, а категориальные кодируются с помощью `OneHotEncoder`.
  * Подготовленный `ColumnTransformer` используется как часть `Pipeline` при обучении моделей и для преобразования входных данных при предсказании.

## База данных (`sqlite_db.py`)

Сервис использует SQLite в качестве базы данных. Файл базы данных по умолчанию `sleep_prediction.db`. При инициализации создаются следующие таблицы:

* **users**: Хранит информацию о пользователях.
  * `id`: INTEGER, PRIMARY KEY, AUTOINCREMENT
  * `username`: TEXT, UNIQUE, NOT NULL
  * `password_hash`: TEXT, NOT NULL
  * `email`: TEXT, UNIQUE, NOT NULL
  * `credits`: INTEGER, NOT NULL, DEFAULT 100
* **models**: Хранит информацию об используемых моделях машинного обучения.
  * `id`: INTEGER, PRIMARY KEY, AUTOINCREMENT
  * `name`: TEXT, UNIQUE, NOT NULL (e.g., "Логистическая регрессия")
  * `type`: TEXT, NOT NULL (e.g., "LogisticRegression")
  * `credit_cost`: INTEGER, NOT NULL (стоимость использования модели)
  * `model_path`: TEXT, NOT NULL (путь к сохраненному файлу модели)
* **predictions**: Хранит историю предсказаний.
  * `id`: INTEGER, PRIMARY KEY, AUTOINCREMENT
  * `user_id`: INTEGER, NOT NULL (FOREIGN KEY to users.id)
  * `model_id`: INTEGER, NOT NULL (FOREIGN KEY to models.id)
  * `input_data`: TEXT, NOT NULL (JSON-строка с входными данными)
  * `prediction_result`: TEXT, NOT NULL (результат предсказания)
  * `timestamp`: TIMESTAMP, NOT NULL
  * `credits_spent`: INTEGER, NOT NULL
* **credits**: Хранит историю операций с кредитами пользователя.
  * `id`: INTEGER, PRIMARY KEY, AUTOINCREMENT
  * `user_id`: INTEGER, NOT NULL (FOREIGN KEY to users.id)
  * `amount`: INTEGER, NOT NULL (изменение баланса, отрицательное для списания)
  * `operation_type`: TEXT, NOT NULL (тип операции, например, "prediction")
  * `timestamp`: TIMESTAMP, NOT NULL
  * `balance_after`: INTEGER, NOT NULL (баланс после операции)

## Запуск

1. **Конфигурация:**

   * Проверьте и при необходимости измените настройки в `config/settings.py`. Особенно важен `DATA_PATH` - путь к CSV-файлу с данными для обучения моделей.
   * Убедитесь, что файл данных, указанный в `DATA_PATH`, существует и доступен для чтения.
2. **Запуск приложения:**
   Приложение запускается через `main.py`.

   ```bash
   python main.py
   ```
   По умолчанию приложение будет доступно по адресу `http://127.0.0.1:3000/`. В режиме отладки (`debug=True`), сервер будет автоматически перезагружаться при изменениях в коде.
3. **База данных:**
   Файл базы данных SQLite (`sleep_prediction.db`) будет создан автоматически при первом запуске, если он не существует. Таблицы также будут созданы автоматически.
4. **Обучение моделей:**
   Модели обучаются автоматически при первом запуске, если они не найдены в базе данных и файловой системе. Данные для обучения берутся из файла, указанного в `DATA_PATH`. Обученные модели сохраняются в папку `models/`.
